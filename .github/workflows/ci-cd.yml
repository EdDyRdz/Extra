name: CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - run: npm ci
      - run: npm test

  build_and_push:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare lowercase owner
        shell: bash
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LC=$OWNER_LC" >> $GITHUB_ENV

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.OWNER_LC }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/basic-vps-pipeline-app:latest
            ghcr.io/${{ env.OWNER_LC }}/basic-vps-pipeline-app:${{ github.sha }}

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
      HAS_DEPLOY: ${{ secrets.VPS_HOST != '' && secrets.VPS_USER != '' && secrets.VPS_SSH_KEY != '' && secrets.GHCR_USERNAME != '' && secrets.GHCR_PAT != '' && secrets.DATADOG_API_KEY != '' }}
    steps:
      - name: Skip deploy (missing VPS/GHCR/Datadog secrets)
        if: ${{ env.HAS_DEPLOY != 'true' }}
        run: echo Skipping deploy due to missing secrets
      - name: Deploy to VPS via SSH
        if: ${{ env.HAS_DEPLOY == 'true' }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
            set -e
            if ! command -v docker >/dev/null 2>&1; then
              apt-get update -y
              apt-get install -y ca-certificates curl gnupg
              install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              chmod a+r /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu noble stable" > /etc/apt/sources.list.d/docker.list
              apt-get update -y
              apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              systemctl enable --now docker
            fi
            owner="${{ github.repository_owner }}"
            owner_lc=$(echo "$owner" | tr '[:upper:]' '[:lower:]')
            echo "${{ env.GHCR_PAT }}" | docker login ghcr.io -u "${{ env.GHCR_USERNAME }}" --password-stdin
            docker pull ghcr.io/${owner_lc}/basic-vps-pipeline-app:${{ github.sha }}
            cat > .env <<'EOF'
            DD_API_KEY=${{ env.DATADOG_API_KEY }}
            DD_SITE=datadoghq.com
            DD_ENV=prod
            EOF
            cat > docker-compose.yml <<EOF
            services:
              app:
                image: ghcr.io/${owner_lc}/basic-vps-pipeline-app:${{ github.sha }}
                environment:
                  - PORT=3000
                  - DD_AGENT_HOST=datadog
                  - DD_ENV=\${DD_ENV}
                expose:
                  - "3000"
                labels:
                  com.datadoghq.ad.logs: '[{"source":"nodejs","service":"basic-vps-pipeline-app"}]'
              nginx:
                image: nginx:alpine
                depends_on:
                  - app
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                labels:
                  com.datadoghq.ad.logs: '[{"source":"nginx","service":"nginx"}]'
              datadog:
                image: datadog/agent:latest
                env_file:
                  - .env
                environment:
                  - DD_APM_ENABLED=true
                  - DD_LOGS_ENABLED=true
                  - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
                volumes:
                  - /var/run/docker.sock:/var/run/docker.sock:ro
                  - /proc:/host/proc:ro
                  - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
            EOF
            cat > nginx.conf <<'EOF'
            events {}
            http {
              server {
                listen 80;
                location / {
                  proxy_pass http://app:3000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                }
              }
            }
            EOF
            docker compose up -d --pull missing --force-recreate
